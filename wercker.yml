box: debian:stable-slim

build:
    steps:
        - shellcheck:
            files: run.sh

        - install-packages:
            packages: unzip curl jq

        - script:
            name: install terraform
            code: |
                #!/bin/bash
                function terraform-install() {
                [[ -f ${HOME}/bin/terraform ]] && echo "`${HOME}/bin/terraform version` already installed at ${HOME}/bin/terraform" && return 0
                LATEST_URL=$(curl -sL https://releases.hashicorp.com/terraform/index.json | jq -r '.versions[].builds[].url' | sort -t. -k 1,1n -k 2,2n -k 3,3n -k 4,4n | egrep -v 'rc|beta' | egrep 'linux.*amd64' |tail -1)
                curl ${LATEST_URL} > /tmp/terraform.zip
                mkdir -p ${HOME}/bin
                (cd ${HOME}/bin && unzip /tmp/terraform.zip)
                if [[ -z $(grep 'export PATH=${HOME}/bin:${PATH}' ~/.bashrc) ]]; then
                echo 'export PATH=${HOME}/bin:${PATH}' >> ~/.bashrc
                fi

                echo "Installed: `${HOME}/bin/terraform version`"

                cat - << EOF 
                Run the following to reload your PATH with terraform:
                source ~/.bashrc
                rm "terraform.zip"
                terraform --v
                EOF
                }
                terraform-install

        - script:
            name: prepare output
            code: |
                mv /tmp/terraform/terraform "${WERCKER_ROOT}/terraform"
                rm -rf "${WERCKER_ROOT}/.git"
                rm -f "${WERCKER_ROOT}/.gitignore"

        - script:
            name: version
            code: |
                "${WERCKER_ROOT}/terraform" --version

publish:
    steps:
        - internal/publish-step:
            owner: saibalaji4
