box: debian:stable-slim

build:
    steps:
        - shellcheck:
            files: run.sh

        - install-packages:
            packages: unzip curl jq git make

        - script:
            name: install terraform
            code: |
                #!/bin/bash
                function terraform-install() {
                    terraform_dir=/tmp/terraform
                    mkdir -p $terraform_dir
                    cd $terraform_dir
                    echo "Installing latest version of terraform"
                    LATEST_URL=$(curl -sL https://releases.hashicorp.com/terraform/index.json | jq -r '.versions[].builds[].url' | sort -t. -k 1,1n -k 2,2n -k 3,3n -k 4,4n | egrep -v 'rc|beta' | egrep 'linux.*amd64' |tail -1)
                    curl ${LATEST_URL} > terraform.zip
                    unzip terraform.zip
                    rm terraform.zip
                }
                function oci-provider-install() {
                    mkdir -p $GOPATH/src/github.com/terraform-providers; cd $GOPATH/src/github.com/terraform-providers
                    git clone git@github.com:terraform-providers/terraform-provider-oci
                    cd $GOPATH/src/github.com/terraform-providers/terraform-provider-oci
                    make build
                }
                oci-provider-install
                terraform-install

        - script:
            name: prepare output
            code: |
                mv /tmp/terraform/terraform "${WERCKER_ROOT}/terraform"
                mv $GOPATH/src/github.com/terraform-providers/terraform-provider-oci/* ${WERCKER_STEP_ROOT}/terraform
                rm -rf "${WERCKER_ROOT}/.git"
                rm -f "${WERCKER_ROOT}/.gitignore"

        - script:
            name: version
            code: |
                "${WERCKER_ROOT}/terraform" --version

publish:
    steps:
        - internal/publish-step:
            owner: saibalaji4
